# 析构和清理

- 对象析构和 Drop 回顾
- 软件中的一般清理要求
- 异步问题
  - 可能希望在清理期间异步执行操作，例如发送最后一条消息
  - 可能需要清理仍在异步使用的东西
  - 可能希望在异步任务完成或取消时进行清理，但无法捕获该情况
  - 清理阶段运行时的状态（特别是如果我们正在恐慌或其他情况）
  - 没有异步 Drop
    - 进行中 (WIP)
  - 前向引用完成 IO 主题

## 取消

- 它是如何发生的（回顾 more-async-await.md）
  - 丢弃 future
  - 取消令牌
  - 中止函数
- 我们可以做些什么来“捕获”取消
  - 记录或监控取消
- 取消如何影响其他 futures 任务（前向引用取消安全章节，这应该只是一个提醒）

## 恐慌和异步

- 跨任务传播恐慌（spawn 结果）
- 恐慌导致数据不一致（tokio 互斥锁）
- 恐慌时调用异步代码（确保你不要这样做）

## 清理模式

- 避免需要清理（中止/重启）
- 不要使用异步进行清理，也不要太担心
- 异步清理方法 + 析构炸弹（即，将清理与析构分离）
- 在单独的任务或线程或监督对象/进程中集中/外包清理
- https://tokio.rs/tokio/topics/shutdown

## 为什么（还）没有异步 Drop

- 注意这是高级部分，不需要阅读
- 为什么异步 Drop 很难
- 可能的解决方案及其问题
- 当前状态
